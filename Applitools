using System;
using System.Threading.Tasks;
using Applitools;
using Applitools.Playwright;
using Microsoft.Playwright;

namespace PlaywrightApplitoolsDemo
{
    class Program
    {
        static async Task Main(string[] args)
        {
            // Set up Applitools Eyes
            var eyes = new Eyes();
            eyes.ApiKey = "YOUR_APPLITOOLS_API_KEY"; // Replace with your Applitools API key

            // Set up Playwright
            var playwright = await Playwright.CreateAsync();
            var browser = await playwright.Chromium.LaunchAsync(new BrowserTypeLaunchOptions { Headless = false });
            var context = await browser.NewContextAsync();
            var page = await context.NewPageAsync();

            try
            {
                // Initialize Applitools Eyes with Playwright
                eyes.SetLogHandler(new StdoutLogHandler(true)); // Optional: Enables Applitools logging to the console
                var eyesDriver = new PlaywrightEyes(eyes, page);

                // Start the visual test
                eyes.Open(eyesDriver, "Playwright .NET App", "Home Page Test");

                // Navigate to the website
                await page.GotoAsync("https://example.com");

                // Capture a screenshot and validate with Applitools
                eyes.CheckWindow("Home Page");

                // Close Eyes and get the results
                eyes.Close();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
            }
            finally
            {
                // Ensure the browser and Eyes are properly closed
                await browser.CloseAsync();
                eyes.AbortIfNotClosed();
            }
        }
    }
}
